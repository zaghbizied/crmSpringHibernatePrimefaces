<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:f="http://java.sun.com/jsf/core" xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets" xmlns:p="http://primefaces.org/ui"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core">
<ui:composition template="/layouts/default.xhtml">
    <ui:define name="title">#{text['clientList.title']}</ui:define>
    <ui:param name="menu" value="AdminMenu"/>

    <ui:define name="body">
        <div class="col-sm-10">
            <h2>#{text['clientList.heading']}</h2>
            <h:form id="form">
                            <p:fieldset legend="Recherche" toggleable="true" toggleSpeed="500">
                                <h:panelGrid columns="4" cellpadding="10" width="100%">
				 	<h:outputLabel for="nom" value="#{text['client.nom']}"/>  
                                        <p:inputText id="nom" value="#{clientController.searchObject.nom}" />                                                    
                                        <h:outputLabel for="prenom" value="#{text['client.prenom']}"/>
                                        <p:inputText id="prenom" value="#{clientController.searchObject.prenom}"></p:inputText>
                                        <h:outputLabel for="ville" value="#{text['client.ville']}"/>
                                        <p:inputText id="ville" value="#{clientController.searchObject.ville}"></p:inputText>
                                        <f:facet name="footer">
                                            <div align="center">
                                                <p:commandButton value="Rechercher" action="#{clientController.search}" update="clients" icon="iconSearch"></p:commandButton>
                                            </div>
                                        </f:facet>
                                </h:panelGrid>
                            </p:fieldset>  
                            <p:separator/>
                            <p:dataTable id="clients" var="client" value="#{clientController.clients}" rows="5" paginator="true" emptyMessage="Aucun client enregistré">
                                        <p:column style="text-align:center" width="8%">
                                            <f:facet name="header">
                                                <p:column sortBy="nom">
                                                    <h:outputText value="#{text['client.nom']}" />
                                                </p:column>
                                            </f:facet>
                                            <h:outputText value="#{client.nom}" escape="true"/>
                                        </p:column>
                                        <p:column style="text-align:center" width="8%">
                                            <f:facet name="header">
                                                <p:column sortBy="prenom">
                                                    <h:outputText value="#{text['client.prenom']}" />
                                                </p:column>
                                            </f:facet>
                                            <h:outputText value="#{client.prenom}" escape="true"/>
                                        </p:column>
                                        <p:column style="text-align:center" width="8%">
                                            <f:facet name="header">
                                                <p:column sortBy="ville">
                                                    <h:outputText value="#{text['client.ville']}" />
                                                </p:column>
                                            </f:facet>
                                            <h:outputText value="#{client.ville}" escape="true"/>
                                        </p:column>
                                        <p:column style="text-align:center" width="8%">
                                            <f:facet name="header">
                                                <p:column sortBy="email">
                                                    <h:outputText value="#{text['client.email']}" />
                                                </p:column>
                                            </f:facet>
                                            <h:outputText value="#{client.email}" escape="true"/>
                                        </p:column>
                                        <p:column style="text-align:center" width="8%">
                                            <f:facet name="header">
                                                <p:column sortBy="adresse">
                                                    <h:outputText value="#{text['client.adresse']}" />
                                                </p:column>
                                            </f:facet>
                                            <h:outputText value="#{client.address}" escape="true"/>
                                        </p:column>
                                        <p:column style="text-align:center" width="15%">
                                            <f:facet name="header">
                                                <p:column sortBy="subject">
                                                    <h:outputText value="#{text['client.numTels']}" />
                                                </p:column>
                                            </f:facet>
                                            <p:dataList value="#{client.nestedNumTels}" var="numTel" type="definition" emptyMessage="Aucun numéro">  
                                                #{numTel.numTel}
                                            </p:dataList>
                                        </p:column>
                                        <p:column style="text-align:center" width="8%">
                                            <f:facet name="header">
                                                <p:column sortBy="id">
                                                    <h:outputText value="Action" />
                                                </p:column>
                                            </f:facet>
                                            <p:commandButton icon="iconEdit" action="#{clientController.prepareUpdate(client)}"
                                                  update=":editForm" oncomplete="PF('editClientWidget').show()">
                                                <p:resetInput target=":editForm" />
                                            </p:commandButton>
                                        </p:column>
                                        <f:facet name="header">
                                                <div align="left">
                                                        <p:commandButton value="Ajouter" icon="iconAdd" action="#{clientController.prepareAdd}"
                                                                    update=":addForm" oncomplete="PF('addClientWidget').show()">
                                                            <p:resetInput target=":addForm" />
                                                        </p:commandButton>
                                                </div>
                                        </f:facet>
                            </p:dataTable>
                            <p:remoteCommand name="updateList" action="#{clientController.search}" update="clients" />
                 </h:form>
        </div>
    </ui:define>
    <ui:define name="dialogs">
           <p:dialog id="editClientDialog" dynamic="true"  appendToBody="false" header="Les détails concernant le client" widgetVar="editClientWidget" resizable="false"  
               showEffect="clip" hideEffect="fold" width="100%" height="500">  
               <p:scrollPanel mode="native">
               <h:form id="editForm">
                    <p:messages id="editMessages"/>
                    <h:panelGrid id="displayEdit" columns="2" cellpadding="4" width="100%">  
                        <h:outputLabel for="nom_e" value="#{text['client.nom']}"/>
                        <p:inputText id="nom_e" value="#{clientController.selectedClient.nom}" required="true" requiredMessage="Le champ nom est requis" maxlength="20"/>                                                    
                        <h:outputLabel for="prenom_e" value="#{text['client.prenom']}"/>
                        <p:inputText id="prenom_e" value="#{clientController.selectedClient.prenom}" required="true" requiredMessage="Le champ prénom est requis" maxlength="20"/> 
                        <h:outputLabel for="adresse_e" value="#{text['client.adresse']}"/>
                        <p:inputTextarea id="adresse_e" value="#{clientController.selectedClient.address}" cols="80" required="true" requiredMessage="Le champ adresse est requis" maxlength="255"/>
                        <h:outputLabel for="ville_e" value="#{text['client.ville']}"/>
                        <p:inputText id="ville_e" value="#{clientController.selectedClient.ville}" required="true" requiredMessage="Le champ ville est requis" maxlength="20"/> 
                        <h:outputLabel for="email_e" value="#{text['client.email']}"/>
                        <p:inputText id="email_e" value="#{clientController.selectedClient.email}" required="true" requiredMessage="Le champ email est requis" maxlength="40"/> 
                        <h:outputLabel for="prix" value="#{text['client.prix']}"/>
                        <p:dataGrid var="prixClient" value="#{clientController.prixClients}" columns="3"  
                            rows="15" paginator="true" id="prix"  
                            paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}">  
                            <p:panel header="#{prixClient.produit.description}" style="text-align:center">  
                                <h:panelGrid columns="2" style="width:100%"> 
                                    <h:outputLabel for="prixUnit">Prix Unitaire</h:outputLabel>
                                    <p:inputText id="prixUnit" value="#{prixClient.prixUnit}" converterMessage="le montant saisi n’a pas pu être interprété en tant que valeur monétaire.">
                                        <f:convertNumber currencySymbol="D.T" maxFractionDigits="3" type="currency" />
                                    </p:inputText>
                                </h:panelGrid>  
                            </p:panel> 
                        </p:dataGrid>
                        <h:outputLabel for="numTels" value="#{text['client.numTels']}"/>
                        <p:dataTable var="numTel" value="#{clientController.numTels}" id="numTels" editable="true" emptyMessage="Aucun numéro">  
                            <p:column headerText="Operateur" style="width:30%">  
                                <p:cellEditor>  
                                    <f:facet name="output">  
                                        <h:outputText value="#{numTel.operateur.nom}" />  
                                    </f:facet>  
                                    <f:facet name="input">  
                                        <p:selectOneMenu value="#{numTel.operateur}" converter="#{operateurConverter}" panelStyle="width:160px" requiredMessage="Le champ opérateur est requis" 
                                                         effect="fade" var="o" style="width:160px"  filter="true" filterMatchMode="contains" required="true">  
				           <f:selectItem itemLabel="Choisir un opérateur" itemValue="" />  
				           <f:selectItems value="#{clientController.operateurs}" var="operateur" itemLabel="#{operateur.nom}" itemValue="#{operateur}"/>  
				           <p:column>  
				               #{o.nom}
				           </p:column>  
				        </p:selectOneMenu>  
                                    </f:facet>  
                                </p:cellEditor>  
                            </p:column>  
                            <p:column headerText="Numéro de téléphone" style="width:30%">  
                                <p:cellEditor>  
                                    <f:facet name="output">  
                                        <h:outputText value="#{numTel.numTel}" />  
                                    </f:facet>  
                                    <f:facet name="input">  
                                        <p:inputMask value="#{numTel.numTel}" maxlength="8" required="true" requiredMessage="Le champ numéro de téléphone est requis" mask="99999999">  
                                            <f:convertNumber type="number" integerOnly="true" />
                                        </p:inputMask>
                                    </f:facet>  
                                </p:cellEditor>  
                            </p:column> 
                            <p:column style="width:6%">  
                                <p:rowEditor />  
                            </p:column> 
                            <f:facet name="footer">
                                <div align="center">
                                    <p:commandButton value="Ajouter Numéro" icon="iconAdd" action="#{clientController.prepareAddNumTel}"
                                           update=":addNumTelForm" oncomplete="PF('addNumTelWidget').show()">
                                        <p:resetInput target=":addNumTelForm" />
                                    </p:commandButton>
                                </div>
                            </f:facet>
                        </p:dataTable>  
            		<f:facet name="footer">
                            <div align="center">
                                <p:commandButton value="Enregistrer" action="#{clientController.update}" icon="ui-icon-disk" process="@this :editForm:displayEdit" update=":editForm:displayEdit,@(.ui-messages)" oncomplete="handleEditClientRequest(xhr, status, args);"/>
                                <p:commandButton value="Supprimer" action="#{clientController.delete}" icon="iconDelete" process="@this :editForm:displayEdit" oncomplete="updateList();PF('editClientWidget').hide();" immediate="true"> 
                                    <p:confirm header="Confirmation" message="Êtes-vous sûr de vouloir supprimer ce client?" icon="ui-icon-alert" />
                                </p:commandButton>
                            </div>
                        </f:facet>
                    </h:panelGrid>  
                 <p:confirmDialog global="true" showEffect="fade" hideEffect="explode">
                    <p:commandButton value="Oui" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
                    <p:commandButton value="Non" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
                 </p:confirmDialog>
                 <p:remoteCommand name="updateEdit" update="numTels" />
                 </h:form>
                 </p:scrollPanel>
                 <script type="text/javascript">  
                    function handleEditClientRequest(xhr, status, args) {  
                        if(!args.validationFailed) {  
                            updateList();
                            PF('editClientWidget').hide();  
                        }   
                        else {  
                            PF('editClientWidget').jq.effect("shake", { times:5 }, 100);  
                        }  
                    }  
               </script>   
            </p:dialog>  
            <p:dialog id="addClientDialog" appendToBody="false" dynamic="true" header="Nouveau client" widgetVar="addClientWidget" resizable="false"  
                      showEffect="clip" hideEffect="fold" width="100%" height="500">  
               <p:scrollPanel mode="native">
               <h:form id="addForm">
                    <p:messages id="addMessages"/>
                    <h:panelGrid id="displayAdd" columns="2" cellpadding="4" width="100%">  
                        <h:outputLabel for="nom" value="#{text['client.nom']}"/>
                        <p:inputText id="nom" value="#{clientController.newClient.nom}" required="true" requiredMessage="Le champ nom est requis" maxlength="20"/>                                                    
                        <h:outputLabel for="prenom" value="#{text['client.prenom']}"/>
                        <p:inputText id="prenom" value="#{clientController.newClient.prenom}" required="true" requiredMessage="Le champ prénom est requis" maxlength="20"/> 
                        <h:outputLabel for="adresse" value="#{text['client.adresse']}"/>
                        <p:inputTextarea id="adresse" value="#{clientController.newClient.address}" cols="80" required="true" requiredMessage="Le champ adresse est requis" maxlength="255"/>
                        <h:outputLabel for="ville" value="#{text['client.ville']}"/>
                        <p:inputText id="ville" value="#{clientController.newClient.ville}" required="true" requiredMessage="Le champ ville est requis" maxlength="20"/> 
                        <h:outputLabel for="email" value="#{text['client.email']}"/>
                        <p:inputText id="email" value="#{clientController.newClient.email}" required="true" requiredMessage="Le champ email est requis" maxlength="40"/> 
                        <h:outputLabel for="prix" value="#{text['client.prix']}"/>
                        <p:dataGrid var="prixClient" value="#{clientController.prixClients}" columns="3"  
                            rows="15" paginator="true" id="prix"  
                            paginatorTemplate="{CurrentPageReport}  {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}">  
                            <p:panel header="#{prixClient.produit.description}" style="text-align:center">  
                                <h:panelGrid columns="2" style="width:100%"> 
                                    <h:outputLabel for="prixUnit">Prix Unitaire</h:outputLabel>
                                    <p:inputText id="prixUnit" value="#{prixClient.prixUnit}" converterMessage="le montant saisi n’a pas pu être interprété en tant que valeur monétaire.">  
                                        <f:convertNumber currencySymbol="D.T" maxFractionDigits="3" type="currency"/>
                                    </p:inputText>
                                </h:panelGrid>  
                            </p:panel> 
                        </p:dataGrid>
                        <h:outputLabel for="numTels" value="#{text['client.numTels']}"/>
                        <p:dataTable var="numTel" value="#{clientController.numTels}" id="numTels" editable="true" emptyMessage="Aucun numéro">  
                            <p:column headerText="Operateur" style="width:30%">  
                                <p:cellEditor>  
                                    <f:facet name="output">  
                                        <h:outputText value="#{numTel.operateur.nom}" />  
                                    </f:facet>  
                                    <f:facet name="input">  
                                        <p:selectOneMenu value="#{numTel.operateur}" converter="#{operateurConverter}" panelStyle="width:160px"  
                                 	effect="fade" var="o" style="width:160px"  filter="true" filterMatchMode="contains" required="true" requiredMessage="Le champ opérateur est requis">  
				           <f:selectItem itemLabel="Choisir un opérateur" itemValue="" />  
				           <f:selectItems value="#{clientController.operateurs}" var="operateur" itemLabel="#{operateur.nom}" itemValue="#{operateur}"/>  
				           <p:column>  
				               #{o.nom}
				           </p:column>  
				        </p:selectOneMenu>  
                                    </f:facet>  
                                </p:cellEditor>  
                            </p:column>  
                            <p:column headerText="Numéro de téléphone" style="width:30%">  
                                <p:cellEditor>  
                                    <f:facet name="output">  
                                        <h:outputText value="#{numTel.numTel}" />  
                                    </f:facet>  
                                    <f:facet name="input">  
                                        <p:inputMask value="#{numTel.numTel}" maxlength="8" required="true" requiredMessage="Le champ numéro de téléphone est requis" mask="99999999">  
                                            <f:convertNumber type="number" integerOnly="true" />
                                        </p:inputMask>
                                    </f:facet>  
                                </p:cellEditor>  
                            </p:column> 
                            <p:column style="width:6%">  
                                <p:rowEditor />  
                            </p:column> 
                            <f:facet name="footer">
                                <div align="center">
                                    <p:commandButton value="Ajouter Numéro" icon="iconAdd" action="#{clientController.prepareAddNumTel}"
                                       update=":addNumTelForm" immediate="true" oncomplete="PF('addNumTelWidget').show()">
                                        <p:resetInput target=":addNumTelForm" />
                                    </p:commandButton>
                                </div>
                            </f:facet>
                        </p:dataTable>  
            		<f:facet name="footer">
                            <div align="center">
                                <p:commandButton value="Enregistrer" action="#{clientController.saveNew}" update=":addForm:displayAdd,@(.ui-messages)" icon="ui-icon-disk" process="@this :addForm:displayAdd" oncomplete="handleAddClientRequest(xhr, status, args);"/>
                            </div>
                        </f:facet>
                    </h:panelGrid>  
                    <p:remoteCommand name="updateAdd" update="numTels"/>
               </h:form>
               </p:scrollPanel>
               <script type="text/javascript">  
                    function handleAddClientRequest(xhr, status, args) {  
                        if(!args.validationFailed) {  
                            updateList();
                            PF('addClientWidget').hide();  
                        }   
                        else {  
                            PF('addClientWidget').jq.effect("shake", { times:5 }, 100);  
                        }  
                    }  
               </script>   
            </p:dialog>  
            <p:dialog id="addNumTelDialog" dynamic="true" appendToBody="false" header="Nouveau Numéro" widgetVar="addNumTelWidget" resizable="false"  
               showEffect="clip" hideEffect="fold">  
               <h:form id="addNumTelForm">
                    <p:messages id="messages"/>
                    <h:panelGrid id="displayAddNumTel" columns="2" cellpadding="4" width="100%">  
                        <h:outputLabel for="operateur" value="Opérateur"/>
                        <p:selectOneMenu id="operateur" value="#{clientController.newNumTel.operateur}" converter="#{operateurConverter}" panelStyle="width:160px"  
                                         effect="fade" var="o" style="width:160px"  filter="true" filterMatchMode="contains" required="true" requiredMessage="Le champ opérateur est requis">  
       		           <f:selectItem itemLabel="Choisir un opérateur" itemValue="" />  
		           <f:selectItems value="#{clientController.operateurs}" var="operateur" itemLabel="#{operateur.nom}" itemValue="#{operateur}"/>  
		           <p:column>  
		               #{o.nom}
		           </p:column>  
                        </p:selectOneMenu>  
                        <h:outputLabel for="numTel" value="Numéro de téléphone"/>
                        <p:inputMask id="numTel" value="#{clientController.newNumTel.numTel}" required="true" requiredMessage="Le champ numéro de téléphone est requis" mask="99999999"> 
                            <f:convertNumber type="number" integerOnly="true" />
                        </p:inputMask>
        		<f:facet name="footer">
                            <div align="center">
                                <p:commandButton value="Enregistrer" action="#{clientController.addNumTel}" oncomplete="handleAddNumTelRequest(xhr, status, args);" icon="ui-icon-disk" process="@this :addNumTelForm:displayAddNumTel"/>
                            </div>
                        </f:facet>
                    </h:panelGrid>  
                    <p:remoteCommand name="updateMessages" update="messages" />
               </h:form>
               <script type="text/javascript">  
                    function handleAddNumTelRequest(xhr, status, args) {  
                        if(!args.validationFailed) { 
                            if(typeof(updateAdd) == "function"){
                                updateAdd();
                            }
                            else if (typeof(updateEdit) == "function"){
                                updateEdit();
                            }
                            PF('addNumTelWidget').hide();  
                        }   
                        else {  
                            updateMessages();
                            PF('addNumTelWidget').jq.effect("shake", { times:5 }, 100);  
                        }  
                    }  
               </script>  
            </p:dialog>  
        </ui:define>
</ui:composition>
</html>